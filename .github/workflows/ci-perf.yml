name: catalog-api-perf

on:
  push:
    branches:
      - '**'

env:
  CATALOG_IMAGE: catalog-api:ci
  BASKET_IMAGE: basket-api:ci
  CATALOG_CONN: "Host=postgres;Port=5432;Username=postgres;Password=postgres;Database=catalogdb;Maximum Pool Size=300;Timeout=15;Command Timeout=30"
  POSTGRES_PASSWORD: postgres
  COMPOSE_FILE: .github/compose/ci.yml
  COMPOSE_PROJECT_NAME: eshopci
  K6_SCRIPTS_DIR: resources/k6/scripts

jobs:
  perf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Restore (web solution filter)
        run: dotnet restore eShop.Web.slnf
      - name: Build (web solution filter)
        run: dotnet build eShop.Web.slnf -c Release --no-restore
      - name: Unit tests (basket)
        run: dotnet test tests/Basket.UnitTests/Basket.UnitTests.csproj -c Release --no-build
      - name: Unit tests (ordering)
        run: dotnet test tests/Ordering.UnitTests/Ordering.UnitTests.csproj -c Release --no-build
      - name: Publish container images for perf
        run: |
          dotnet publish src/Catalog.API/Catalog.API.csproj -c Release -r linux-x64 \
            /t:PublishContainer -p:ContainerRepository=catalog-api -p:ContainerImageTags=ci
          dotnet publish src/Basket.API/Basket.API.csproj -c Release -r linux-x64 \
            /t:PublishContainer -p:ContainerRepository=basket-api -p:ContainerImageTags=ci
      - name: Clean state (containers/volumes)
        run: docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE down -v || true
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Start dependencies
        run: docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE up -d postgres redis rabbitmq
      - name: Wait for Postgres
        run: |
          for i in {1..5}; do
            if docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE exec -T postgres pg_isready -U postgres; then
              echo "Postgres is ready"
              exit 0
            fi
            echo "Waiting for Postgres... (${i}/5)"
            sleep 3
          done
          echo "Postgres did not become ready, showing logs"
          docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE logs --tail=200
          exit 1
      - name: Wait for RabbitMQ
        run: |
          for i in {1..5}; do
            if docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE exec -T rabbitmq rabbitmq-diagnostics -q ping; then
              echo "RabbitMQ is ready"
              exit 0
            fi
            echo "Waiting for RabbitMQ... (${i}/5)"
            sleep 3
          done
          echo "RabbitMQ did not become ready, showing logs"
          docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE logs --tail=200 rabbitmq
          exit 1
      - name: Apply catalog migrations
        run: |
          docker run --rm --network ${COMPOSE_PROJECT_NAME}_default \
            -v "$PWD":/work -w /work \
            -e ConnectionStrings__catalogdb="$CATALOG_CONN" \
            -e ConnectionStrings__EventBus="amqp://eshop:eshop@rabbitmq:5672" \
            mcr.microsoft.com/dotnet/sdk:9.0 bash -lc "\
              set -euo pipefail; \
              dotnet tool install --global dotnet-ef --version 9.0.* || true; \
              export PATH=\"\$PATH:/root/.dotnet/tools\"; \
              dotnet clean eShop.slnx -c Release || true; \
              dotnet restore src/Catalog.API/Catalog.API.csproj; \
              dotnet build src/Catalog.API/Catalog.API.csproj -c Release; \
              dotnet ef database update --project src/Catalog.API/Catalog.API.csproj --configuration Release --verbose" \
          || { echo 'Migration failed, showing Postgres logs'; docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE logs --tail=200 postgres; exit 1; }
      - name: Start APIs
        run: |
          # Small grace period after dependencies are healthy
          sleep 5
          docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE up -d catalog-api basket-api
          echo "Waiting for APIs..."
          for i in {1..5}; do
            if curl -sf http://localhost:18080/health || curl -sf http://catalog-api:8080/health; then
              echo "catalog-api is up"
              exit 0
            fi
            echo "catalog-api not ready yet (${i}/5)..."
            sleep 5
          done
          echo "catalog-api did not become ready, showing logs..."
          docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE logs --tail=200 catalog-api postgres
          exit 1
      - name: k6 read test
        run: |
          docker run --rm --network ${COMPOSE_PROJECT_NAME}_default \
            -v "$PWD":/work -w /work \
            -e BASE_URL=http://catalog-api:8080 \
            grafana/k6:0.54.0 \
            run --summary-export read-summary.json ${K6_SCRIPTS_DIR}/catalog-api-closed-model-read-test-quick.js
      - name: k6 write test
        run: |
          docker run --rm --network ${COMPOSE_PROJECT_NAME}_default \
            -v "$PWD":/work -w /work \
            -e BASE_URL=http://catalog-api:8080 \
            grafana/k6:0.54.0 \
            run --summary-export write-summary.json ${K6_SCRIPTS_DIR}/catalog-api-closed-model-write-test-quick.js
      - name: Assert thresholds
        run: node .github/scripts/assert-k6.js read-summary.json write-summary.json
      - name: Teardown
        if: always()
        run: docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE down -v
