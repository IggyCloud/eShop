name: catalog-api-perf

on:
  push:
    branches:
      - '**'

env:
  CATALOG_IMAGE: catalog-api:ci
  BASKET_IMAGE: basket-api:ci
  CATALOG_CONN: "Host=postgres;Port=5432;Username=postgres;Password=postgres;Database=catalogdb;Maximum Pool Size=300;Timeout=15;Command Timeout=30"
  POSTGRES_PASSWORD: postgres
  COMPOSE_FILE: .github/compose/ci.yml
  COMPOSE_PROJECT_NAME: eshopci
  K6_RESOURCES_REPO: IggyCloud/IggyCloudResources
  K6_RESOURCES_REF: main
  K6_RESOURCES_PATH: k6-resources
  K6_SCRIPTS_DIR: k6-resources/k6/scripts

jobs:
  perf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Restore (web solution filter)
        run: dotnet restore eShop.Web.slnf
      - name: Build (web solution filter)
        run: dotnet build eShop.Web.slnf -c Release --no-restore
      - name: Unit tests (basket)
        run: dotnet test tests/Basket.UnitTests/Basket.UnitTests.csproj -c Release --no-build
      - name: Unit tests (ordering)
        run: dotnet test tests/Ordering.UnitTests/Ordering.UnitTests.csproj -c Release --no-build
      - name: Publish container images for perf
        run: |
          dotnet publish src/Catalog.API/Catalog.API.csproj -c Release -r linux-x64 \
            /t:PublishContainer -p:ContainerRepository=catalog-api -p:ContainerImageTags=ci
          dotnet publish src/Basket.API/Basket.API.csproj -c Release -r linux-x64 \
            /t:PublishContainer -p:ContainerRepository=basket-api -p:ContainerImageTags=ci
      - name: Checkout k6 resources
        uses: actions/checkout@v4
        with:
          repository: ${{ env.K6_RESOURCES_REPO }}
          ref: ${{ env.K6_RESOURCES_REF }}
          path: ${{ env.K6_RESOURCES_PATH }}
          token: ${{ secrets.K6_RESOURCES_TOKEN != '' && secrets.K6_RESOURCES_TOKEN || github.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Start dependencies
        run: docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE up -d postgres redis rabbitmq
      - name: Start APIs
        run: |
          docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE up -d catalog-api basket-api
          echo "Waiting for APIs..."
          for i in {1..30}; do
            if curl -sf http://localhost:18080/health || curl -sf http://catalog-api:8080/health; then
              echo "catalog-api is up"
              exit 0
            fi
            echo "catalog-api not ready yet (${i}/30)..."
            sleep 5
          done
          echo "catalog-api did not become ready, showing logs..."
          docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE logs --tail=200
          exit 1
      - name: k6 read test
        run: |
          docker run --rm --network ${COMPOSE_PROJECT_NAME}_default \
            -v "$PWD":/work -w /work \
            -e BASE_URL=http://catalog-api:8080 \
            grafana/k6:0.54.0 \
            run --summary-export read-summary.json ${K6_SCRIPTS_DIR}/catalog-api-closed-model-read-test-quick.js
      - name: k6 write test
        run: |
          docker run --rm --network ${COMPOSE_PROJECT_NAME}_default \
            -v "$PWD":/work -w /work \
            -e BASE_URL=http://catalog-api:8080 \
            grafana/k6:0.54.0 \
            run --summary-export write-summary.json ${K6_SCRIPTS_DIR}/catalog-api-closed-model-write-test-quick.js
      - name: Assert thresholds
        run: node .github/scripts/assert-k6.js read-summary.json write-summary.json
      - name: Teardown
        if: always()
        run: docker compose -p $COMPOSE_PROJECT_NAME -f $COMPOSE_FILE down -v
